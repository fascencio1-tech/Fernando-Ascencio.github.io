<!--
README - paraPublicar.html

Descripción:
Este archivo contiene una interfaz y un "simulador" de base de datos para subir/gestionar
artículos. Los datos se almacenan localmente en el navegador usando localStorage bajo la
clave 'articulos_db_v1'.

Cómo usar:
- Abrir el archivo en un navegador (doble clic en Windows o abrir con el navegador).
- Rellenar el formulario y presionar "Guardar artículo" para crear uno nuevo.
- Buscar por título o etiqueta en la caja de búsqueda.
- Editar, eliminar, exportar o importar artículos usando los botones.

Limitaciones:
- Es una simulación local: los datos quedan en el equipo del usuario (localStorage).
- No hay autenticación ni concurrencia.
-->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <link rel="stylesheet" href="paraPublicar.css">
  <title>Simulador: Subir Publicaciones</title>
</head>
<body>
  <div class="container">
    <h1>Simulador: Subir Publicaciones</h1>
    <p class="small">Formulario para crear/editar artículos. Los artículos se guardan en Local Storage (clave: <code>articulos_db_v1</code>).</p>

    <div class="searchbar">
      <input id="searchInput" type="text" placeholder="Buscar por título o etiqueta..." />
      <button id="clearSearch" class="secondary">Limpiar</button>
      <div style="flex:1"></div>
      <button id="exportBtn">Exportar JSON</button>
      <button id="importBtn" class="secondary">Importar JSON</button>
      <a href="Articulos.html"><button type="button" class="secondary">Ver Artículos</button></a>
      <input id="fileInput" class="file-input" type="file" accept="application/json" />
    </div>

    <form id="articleForm" onsubmit="return false;">
      <div class="main">
        <input id="title" type="text" placeholder="Título" required />
        <div style="display:flex;gap:8px;align-items:center">
          <label style="min-width:90px">Tipo:</label>
          <select id="typeSelect" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccd">
            <option value="publicacion">Publicación</option>
            <option value="foto">Foto</option>
          </select>
        </div>
        <div>
          <label class="small">Imagen (opcional)</label>
          <input id="imageInput" type="file" accept="image/*" />
        </div>
        <textarea id="content" placeholder="Contenido / Cuerpo del artículo" required></textarea>
        <input id="tags" type="text" placeholder="Etiquetas (separadas por comas)" />
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px">
          <label style="min-width:150px">¿Dónde quieres publicar?</label>
          <select id="publishLocation" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccd">
            <option value="Articulos.html">Artículos</option>
            <option value="sistemaSolar.html">Sistema Solar</option>
            <option value="nebulosas.html">Nebulosas</option>
            <option value="constelaciones.html">Constelaciones</option>
            <option value="galaxias.html">Galaxias</option>
          </select>
        </div>
        <div class="controls">
          <button id="saveBtn">Guardar artículo</button>
          <button id="newBtn" type="button" class="secondary">Nuevo</button>
          <div style="flex:1"></div>
          <span id="statusMsg" class="small"></span>
        </div>
      </div>

      <aside class="sidebar">
        <div class="small"><strong>Previsualización</strong></div>
        <div id="preview" style="min-height:120px;padding:10px;border-radius:6px;border:1px solid #eef; background:#fff"></div>
        <div style="margin-top:12px">
          <label class="small">ID (solo lectura)</label>
          <input id="articleId" type="text" readonly />
        </div>
      </aside>
    </form>

    <div class="list" id="articlesList"></div>

    <div class="filter-section">
      <h2>Filtrar por ubicación</h2>
      <button onclick="filterByLocation('sistemaSolar.html')">Sistema Solar</button>
      <button onclick="filterByLocation('nebulosas.html')">Nebulosas</button>
      <button onclick="filterByLocation('constelaciones.html')">Constelaciones</button>
      <button onclick="filterByLocation('galaxias.html')">Galaxias</button>
    </div>

    <footer>
      <div>Clave localStorage: <code>articulos_db_v1</code></div>
      <div>Nota: Este es un simulador local — los datos no se sincronizan con un servidor.</div>
    </footer>
  </div>

  <script>
    // Contrato: artículo = { id:string, title:string, content:string, tags:string[], type:string, imageData?:string, createdAt:number, updatedAt:number }
    const STORAGE_KEY = 'articulos_db_v1'

    // Utilidades
    function readStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY)
        return raw ? JSON.parse(raw) : []
      }catch(e){
        console.error('Error parseando storage', e)
        return []
      }
    }
    function writeStorage(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr))
    }

    // DOM
    const titleEl = document.getElementById('title')
    const contentEl = document.getElementById('content')
    const tagsEl = document.getElementById('tags')
    const saveBtn = document.getElementById('saveBtn')
    const newBtn = document.getElementById('newBtn')
    const previewEl = document.getElementById('preview')
    const articleIdEl = document.getElementById('articleId')
    const articlesList = document.getElementById('articlesList')
    const searchInput = document.getElementById('searchInput')
    const clearSearch = document.getElementById('clearSearch')
    const exportBtn = document.getElementById('exportBtn')
    const importBtn = document.getElementById('importBtn')
    const fileInput = document.getElementById('fileInput')
    const statusMsg = document.getElementById('statusMsg')
    const imageInput = document.getElementById('imageInput')
    const typeSelect = document.getElementById('typeSelect')
    const publishLocation = document.getElementById('publishLocation')

    // Estado
    let articles = readStorage()
    let editingId = null
    let currentImageData = null // dataURL temporal mientras se edita

    // Render
    function renderList(filter=''){
      articlesList.innerHTML = ''
      const q = filter.trim().toLowerCase()
      const filtered = articles.filter(a => {
        if(!q) return true
        if(a.title.toLowerCase().includes(q)) return true
        if(a.tags && a.tags.some(t => t.toLowerCase().includes(q))) return true
        if(a.type && a.type.toLowerCase().includes(q)) return true
        return false
      }).sort((a,b)=> b.updatedAt - a.updatedAt)

      if(filtered.length===0){
        articlesList.innerHTML = '<div class="small">No hay artículos.</div>'
        return
      }

      for(const art of filtered){
        const div = document.createElement('div')
        div.className = 'article'
        const imgHtml = art.imageData ? `<div style="margin-top:8px"><img src="${art.imageData}" alt="img" style="max-width:140px;border-radius:6px;display:block;border:1px solid #e2e8f0"/></div>` : ''
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>${escapeHtml(art.title)}</strong>
              <div class="meta">Tipo: ${escapeHtml(art.type||'publicacion')} · Creado: ${new Date(art.createdAt).toLocaleString()} · Actualizado: ${new Date(art.updatedAt).toLocaleString()}</div>
            </div>
            <div class="tags">${(art.tags||[]).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
          </div>
          ${imgHtml}
          <div style="margin-top:8px">${escapeHtml(art.content).slice(0,400)}${art.content.length>400? '...' : ''}</div>
          <div class="actions">
            <button data-action="edit" data-id="${art.id}">Editar</button>
            <button data-action="delete" data-id="${art.id}" class="secondary">Borrar</button>
            <button data-action="copy" data-id="${art.id}" class="secondary">Copiar</button>
            <button data-action="download" data-id="${art.id}">Descargar JSON</button>
          </div>
        `

        // Event handlers
        div.querySelector('[data-action="edit"]').addEventListener('click', ()=> loadIntoForm(art.id))
        div.querySelector('[data-action="delete"]').addEventListener('click', ()=> deleteArticle(art.id))
        div.querySelector('[data-action="copy"]').addEventListener('click', ()=> copyContent(art.id))
        div.querySelector('[data-action="download"]').addEventListener('click', ()=> downloadArticle(art.id))

        articlesList.appendChild(div)
      }
    }

    function escapeHtml(str){
      return String(str||'')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;')
    }

    function refreshPreview(){
      const title = escapeHtml(titleEl.value||'(sin título)')
      const content = escapeHtml(contentEl.value||'')
      const tagsHtml = (tagsEl.value||'').split(',').map(s=>s.trim()).filter(Boolean).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')
      const type = escapeHtml(typeSelect.value)
      const imgHtml = currentImageData ? `<div style="margin-top:8px"><img src="${currentImageData}" alt="img" style="max-width:180px;border-radius:6px;display:block;border:1px solid #e2e8f0"/></div>` : ''
      previewEl.innerHTML = `<strong>${title}</strong><div style="margin-top:6px">${content}</div><div style="margin-top:8px" class="tags">${tagsHtml}</div><div style="margin-top:6px" class="small">Tipo: ${type}</div>${imgHtml}`
    }

    // CRUD
    function saveArticle(){
      const title = titleEl.value.trim()
      const content = contentEl.value.trim()
      const tags = tagsEl.value.split(',').map(s=>s.trim()).filter(Boolean)
      const type = typeSelect.value
      if(!title || !content){
        setStatus('Título y contenido son requeridos', true)
        return
      }

      if(editingId){
        const idx = articles.findIndex(a=>a.id===editingId)
        if(idx===-1){ setStatus('Artículo a editar no encontrado', true); return }
        articles[idx].title = title
        articles[idx].content = content
        articles[idx].tags = tags
        articles[idx].type = type
        // si hay imagen seleccionada en currentImageData, actualizar; si no, mantener la existente
        if(currentImageData !== null){ articles[idx].imageData = currentImageData }
        articles[idx].updatedAt = Date.now()
        setStatus('Artículo actualizado')
      } else {
        const art = { id: 'art_'+Date.now()+'_'+Math.random().toString(36).slice(2,7), title, content, tags, type, imageData: currentImageData || null, createdAt: Date.now(), updatedAt: Date.now() }
        articles.push(art)
        setStatus('Artículo creado')
      }

      writeStorage(articles)
      clearForm()
      renderList(searchInput.value)
    }

    function loadIntoForm(id){
      const art = articles.find(a=>a.id===id)
      if(!art) { setStatus('Artículo no encontrado', true); return }
      editingId = art.id
      titleEl.value = art.title
      contentEl.value = art.content
      tagsEl.value = (art.tags||[]).join(', ')
      articleIdEl.value = art.id
      typeSelect.value = art.type || 'publicacion'
      currentImageData = art.imageData || null
      refreshPreview()
      setStatus('Editando artículo')
    }

    function deleteArticle(id){
      if(!confirm('¿Borrar este artículo? Esta acción no se puede deshacer.')) return
      articles = articles.filter(a=>a.id!==id)
      writeStorage(articles)
      if(editingId===id) clearForm()
      renderList(searchInput.value)
      setStatus('Artículo borrado')
    }

    function clearForm(){
      editingId = null
      titleEl.value = ''
      contentEl.value = ''
      tagsEl.value = ''
      articleIdEl.value = ''
      typeSelect.value = 'publicacion'
      imageInput.value = ''
      currentImageData = null
      refreshPreview()
      setStatus('Formulario listo')
    }

    // Extras
    function copyContent(id){
      const art = articles.find(a=>a.id===id)
      if(!art) return setStatus('No encontrado', true)
      navigator.clipboard && navigator.clipboard.writeText(art.content).then(()=> setStatus('Contenido copiado al portapapeles')).catch(()=> setStatus('No se pudo copiar', true))
    }

    function downloadArticle(id){
      const art = articles.find(a=>a.id===id)
      if(!art) return
      const blob = new Blob([JSON.stringify(art, null, 2)], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `${art.id}.json`
      document.body.appendChild(a)
      a.click()
      a.remove()
      URL.revokeObjectURL(url)
    }

    // Export/Import
    function exportAll(){
      const blob = new Blob([JSON.stringify(articles, null, 2)], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `articulos_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`
      document.body.appendChild(a)
      a.click()
      a.remove()
      URL.revokeObjectURL(url)
      setStatus('Exportado')
    }

    function importFromFile(file){
      const reader = new FileReader()
      reader.onload = e => {
        try{
          const json = JSON.parse(e.target.result)
          if(!Array.isArray(json)) throw new Error('Formato inválido: se esperaba un array')
          // Simple merge: añadir nuevos ids y mantener existentes
          const existingIds = new Set(articles.map(a=>a.id))
          const toAdd = json.filter(item => item && item.id && !existingIds.has(item.id)).map(item=>({
            id: item.id,
            title: item.title||'(sin título)',
            content: item.content||'',
            tags: Array.isArray(item.tags)? item.tags : (typeof item.tags==='string' ? item.tags.split(',').map(s=>s.trim()).filter(Boolean) : []),
            type: item.type || 'publicacion',
            imageData: item.imageData || null,
            createdAt: item.createdAt || Date.now(),
            updatedAt: item.updatedAt || Date.now()
          }))
          articles = articles.concat(toAdd)
          writeStorage(articles)
          renderList(searchInput.value)
          setStatus(`Importado ${toAdd.length} artículo(s)`)
        }catch(err){
          setStatus('Error importando: '+err.message, true)
        }
      }
      reader.readAsText(file)
    }

    // Image handling
    imageInput.addEventListener('change', e => {
      const f = e.target.files && e.target.files[0]
      if(!f){ currentImageData = null; refreshPreview(); return }
      const reader = new FileReader()
      reader.onload = ev => { currentImageData = ev.target.result; refreshPreview() }
      reader.readAsDataURL(f)
    })

    // Helpers
    function setStatus(msg, isError=false){
      statusMsg.textContent = msg
      statusMsg.style.color = isError ? '#b91c1c' : '#064e3b'
      setTimeout(()=>{ if(statusMsg.textContent===msg) statusMsg.textContent = '' }, 3000)
    }

    // Events
    saveBtn.addEventListener('click', saveArticle)
    newBtn.addEventListener('click', clearForm)
    titleEl.addEventListener('input', refreshPreview)
    contentEl.addEventListener('input', refreshPreview)
    tagsEl.addEventListener('input', refreshPreview)
    typeSelect.addEventListener('change', refreshPreview)
    searchInput.addEventListener('input', ()=> renderList(searchInput.value))
    clearSearch.addEventListener('click', ()=>{ searchInput.value=''; renderList(); })
    exportBtn.addEventListener('click', exportAll)
    importBtn.addEventListener('click', ()=> fileInput.click())
    fileInput.addEventListener('change', (e)=>{ const f = e.target.files[0]; if(f) importFromFile(f); fileInput.value=''; })

    // Redefinir la función de guardar para incluir la lógica de ubicación
    function saveArticleToLocation() {
      const location = publishLocation.value;
      const title = titleEl.value.trim();
      const content = contentEl.value.trim();
      const tags = tagsEl.value.split(',').map(s => s.trim()).filter(Boolean);
      const type = typeSelect.value;

      if (!title || !content) {
        setStatus('Título y contenido son requeridos', true);
        return;
      }

      const article = {
        id: editingId || 'art_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7),
        title,
        content,
        tags,
        type,
        imageData: currentImageData || null,
        createdAt: editingId ? articles.find(a => a.id === editingId).createdAt : Date.now(),
        updatedAt: Date.now()
      };

      const storageKey = location.replace('.html', '_db');
      const existingArticles = JSON.parse(localStorage.getItem(storageKey) || '[]');

      if (editingId) {
        const index = existingArticles.findIndex(a => a.id === editingId);
        if (index !== -1) {
          existingArticles[index] = article;
        }
      } else {
        existingArticles.push(article);
      }

      localStorage.setItem(storageKey, JSON.stringify(existingArticles));

      setStatus(`Artículo ${editingId ? 'actualizado' : 'publicado'} en ${location}`);
      clearForm();
      renderList();
    }

    saveBtn.removeEventListener('click', saveArticle);
    saveBtn.addEventListener('click', saveArticleToLocation);

    function loadIntoFormFromLocation(id) {
      const location = publishLocation.value;
      const storageKey = location.replace('.html', '_db');
      const existingArticles = JSON.parse(localStorage.getItem(storageKey) || '[]');
      const article = existingArticles.find(a => a.id === id);

      if (!article) {
        setStatus('Artículo no encontrado', true);
        return;
      }

      editingId = article.id;
      titleEl.value = article.title;
      contentEl.value = article.content;
      tagsEl.value = article.tags.join(', ');
      typeSelect.value = article.type;
      currentImageData = article.imageData || null;
      refreshPreview();
      setStatus('Editando artículo');
    }

    function deleteArticleFromLocation(id) {
      if (!confirm('¿Borrar este artículo? Esta acción no se puede deshacer.')) return;

      // 1️⃣ Borrar del almacenamiento principal (por compatibilidad)
      articles = articles.filter(a => a.id !== id);
      writeStorage(articles);

      // 2️⃣ Borrar también de todas las ubicaciones posibles
      const locations = ['sistemaSolar.html', 'nebulosas.html', 'constelaciones.html', 'galaxias.html'];
      locations.forEach(loc => {
        const key = loc.replace('.html', '_db');
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        const updated = arr.filter(a => a.id !== id);
        localStorage.setItem(key, JSON.stringify(updated));
      });

      // 3️⃣ Refrescar lista
      renderList(searchInput.value);
      setStatus('Artículo borrado en todas las ubicaciones');
    }

    function filterByLocation(location) {
      const storageKey = location.replace('.html', '_db');
      const articles = JSON.parse(localStorage.getItem(storageKey) || '[]');

      const container = document.getElementById('articlesList');
      container.innerHTML = '';

      if (articles.length === 0) {
        container.innerHTML = '<p>No hay publicaciones en esta ubicación.</p>';
        return;
      }

      articles.forEach(article => {
        const card = document.createElement('div');
        card.className = 'article';
        card.innerHTML = `
          <h2>${article.title}</h2>
          ${article.imageData ? `<img src="${article.imageData}" alt="${article.title}" style="width:100%;border-radius:8px;margin-bottom:8px;">` : ''}
          <p>${article.content.slice(0, 200)}${article.content.length > 200 ? '...' : ''}</p>
          <div class="tags">${article.tags.map(tag => `<span>${tag}</span>`).join(' ')}</div>
          <button onclick="loadIntoFormFromLocation('${article.id}')">Editar</button>
          <button onclick="deleteArticleFromLocation('${article.id}')">Borrar</button>
        `;
        container.appendChild(card);
      });
    }

    // Validar datos en localStorage
    function validateStorage() {
      const locations = ['sistemaSolar.html', 'nebulosas.html', 'constelaciones.html', 'galaxias.html'];
      locations.forEach(location => {
        const storageKey = location.replace('.html', '_db');
        const articles = JSON.parse(localStorage.getItem(storageKey) || '[]');
        if (!Array.isArray(articles)) {
          console.warn(`Datos corruptos en ${storageKey}, reiniciando...`);
          localStorage.setItem(storageKey, '[]');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', validateStorage);
  </script>

  <style>
    .filter-section {
      margin-bottom: 20px;
    }

    .filter-section button {
      margin-right: 10px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .filter-section button:hover {
      background-color: #0056b3;
    }
  </style>
</body>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const editId = localStorage.getItem('edit_article_id');
    const editKey = localStorage.getItem('edit_storage_key');

    if (editKey) {
      // Si viene un id + key => editar artículo existente en storage remoto
      if (editId) {
        const storedArticles = JSON.parse(localStorage.getItem(editKey) || '[]');
        const art = storedArticles.find(a => a.id === editId);
        if (art) {
          editingId = art.id;
          titleEl.value = art.title;
          contentEl.value = art.content;
          tagsEl.value = (art.tags || []).join(', ');
          typeSelect.value = art.type || 'publicacion';
          currentImageData = art.imageData || null;
          publishLocation.value = editKey.replace('_db', '.html');
          refreshPreview();
          setStatus('Editando publicación desde otra página');
        } else {
          // id no encontrado: limpiar y dejar que el usuario cree
          publishLocation.value = editKey.replace('_db', '.html');
          setStatus('Ubicación seleccionada para nueva publicación');
        }
      } else {
        // Solo viene la key: preparar formulario para crear en esa ubicación
        editingId = null;
        publishLocation.value = editKey.replace('_db', '.html');
        clearForm();
        setStatus('Creando nueva publicación en ' + publishLocation.value);
      }

      // Limpiar los datos temporales
      localStorage.removeItem('edit_article_id');
      localStorage.removeItem('edit_storage_key');
    }
  });

</script>
</html>